import{r as reactExports}from"./vendor-WBEadHvS.js";import{p as getWebSocketUrl}from"./index-lko4Hfbd.js";const useChatCollaboration=options=>{const{userId,userName=userId,autoConnect=!0,onMessageReceived,onUserJoined,onUserLeft,onTypingUpdate}=options,[state,setState]=reactExports.useState({isConnected:!1,isConnecting:!1,currentRoom:null,rooms:[],messages:{},typingUsers:{},roomMembers:{},connectionError:null}),wsRef=reactExports.useRef(null),reconnectTimeoutRef=reactExports.useRef(null),typingTimeoutRef=reactExports.useRef(null),updateState=reactExports.useCallback(updates=>{setState(prev=>({...prev,...updates}))},[]),connect=reactExports.useCallback(()=>{var _a;if(((_a=wsRef.current)==null?void 0:_a.readyState)===WebSocket.OPEN){console.log("Already connected");return}updateState({isConnecting:!0,connectionError:null});const wsUrl=getWebSocketUrl(`/chat/${encodeURIComponent(userId)}/${encodeURIComponent(userName)}`);console.log("ðŸ”Œ Connecting to chat:",wsUrl);try{const ws=new WebSocket(wsUrl);wsRef.current=ws,ws.onopen=()=>{console.log("âœ… Chat connected successfully"),updateState({isConnected:!0,isConnecting:!1,connectionError:null})},ws.onmessage=event=>{try{const data=JSON.parse(event.data);handleMessage(data)}catch(error){console.error("Failed to parse message:",error)}},ws.onclose=event=>{console.log("ðŸ”Œ Chat disconnected:",event.code,event.reason),updateState({isConnected:!1,isConnecting:!1,connectionError:event.code===1e3?null:"Connection lost"}),wsRef.current=null,event.code!==1e3&&autoConnect&&(reconnectTimeoutRef.current=setTimeout(()=>{console.log("ðŸ”„ Attempting to reconnect..."),connect()},3e3))},ws.onerror=error=>{console.error("âŒ Chat WebSocket error:",error),updateState({connectionError:"Connection failed",isConnecting:!1})}}catch(error){console.error("Failed to create WebSocket:",error),updateState({isConnecting:!1,connectionError:"Failed to create connection"})}},[userId,userName,autoConnect,updateState]),disconnect=reactExports.useCallback(()=>{reconnectTimeoutRef.current&&(clearTimeout(reconnectTimeoutRef.current),reconnectTimeoutRef.current=null),wsRef.current&&(wsRef.current.close(1e3,"User disconnected"),wsRef.current=null),updateState({isConnected:!1,isConnecting:!1,connectionError:null})},[updateState]),sendMessage=reactExports.useCallback((action,data={})=>{if(!wsRef.current||wsRef.current.readyState!==WebSocket.OPEN)return console.error("Not connected to chat"),!1;try{const message={action,...data};return wsRef.current.send(JSON.stringify(message)),!0}catch(error){return console.error("Failed to send message:",error),!1}},[]),handleMessage=reactExports.useCallback(data=>{var _a,_b;switch(console.log("ðŸ“¥ Chat message received:",data),data.type){case"connection_success":console.log("âœ… Chat connection confirmed"),sendMessage("get_rooms");break;case"chat_message":onMessageReceived&&onMessageReceived(data),setState(prev=>({...prev,messages:{...prev.messages,[data.room_id]:[...prev.messages[data.room_id]||[],data].slice(-100)}}));break;case"room_joined":setState(prev=>({...prev,currentRoom:data.room_id,messages:{...prev.messages,[data.room_id]:data.recent_messages||[]},roomMembers:{...prev.roomMembers,[data.room_id]:data.members||[]}}));break;case"room_created":setState(prev=>({...prev,rooms:[...prev.rooms,{room_id:data.room_id,room_name:data.room_name,member_count:1,last_message:null,created_at:data.timestamp}]}));break;case"room_list":setState(prev=>({...prev,rooms:data.rooms||[]}));break;case"user_joined_room":onUserJoined&&onUserJoined({user_id:data.user_id,user_name:data.user_name,status:"online",connected_at:data.timestamp});break;case"user_left_room":onUserLeft&&onUserLeft({user_id:data.user_id,user_name:data.user_name,status:"offline",connected_at:data.timestamp});break;case"typing_update":onTypingUpdate&&onTypingUpdate(data.typing_users||[]),setState(prev=>({...prev,typingUsers:{...prev.typingUsers,[data.room_id]:data.typing_users||[]}}));break;case"action_result":(_a=data.result)!=null&&_a.success||console.error("Action failed:",data.action,(_b=data.result)==null?void 0:_b.message);break;case"error":console.error("Chat error:",data.message);break;default:console.log("Unknown message type:",data.type)}},[onMessageReceived,onUserJoined,onUserLeft,onTypingUpdate,sendMessage]),createRoom=reactExports.useCallback((roomId,roomName)=>sendMessage("create_room",{room_id:roomId,room_name:roomName}),[sendMessage]),joinRoom=reactExports.useCallback(roomId=>sendMessage("join_room",{room_id:roomId}),[sendMessage]),leaveRoom=reactExports.useCallback(roomId=>sendMessage("leave_room",{room_id:roomId}),[sendMessage]),sendChatMessage=reactExports.useCallback((roomId,message,messageType="text")=>sendMessage("send_message",{room_id:roomId,message,message_type:messageType}),[sendMessage]),setTyping=reactExports.useCallback((roomId,isTyping)=>{typingTimeoutRef.current&&clearTimeout(typingTimeoutRef.current),sendMessage("typing",{room_id:roomId,is_typing:isTyping}),isTyping&&(typingTimeoutRef.current=setTimeout(()=>{sendMessage("typing",{room_id:roomId,is_typing:!1})},3e3))},[sendMessage]),getRooms=reactExports.useCallback(()=>sendMessage("get_rooms"),[sendMessage]);return reactExports.useEffect(()=>(autoConnect&&connect(),()=>{disconnect()}),[autoConnect,connect,disconnect]),reactExports.useEffect(()=>()=>{reconnectTimeoutRef.current&&clearTimeout(reconnectTimeoutRef.current),typingTimeoutRef.current&&clearTimeout(typingTimeoutRef.current)},[]),{...state,connect,disconnect,createRoom,joinRoom,leaveRoom,sendChatMessage,setTyping,getRooms,isInRoom:roomId=>state.currentRoom===roomId,getRoomMessages:roomId=>state.messages[roomId]||[],getRoomTypingUsers:roomId=>state.typingUsers[roomId]||[],getRoomMembers:roomId=>state.roomMembers[roomId]||[]}};export{useChatCollaboration as u};
